---
- name: Add Grafana repository
  ansible.builtin.yum_repository:
    name: grafana
    description: Grafana Repository
    baseurl: https://rpm.grafana.com/oss/rpm
    gpgcheck: yes
    gpgkey: https://rpm.grafana.com/gpg.key
    enabled: yes

- name: Install Grafana
  ansible.builtin.yum:
    name: grafana
    state: present

- name: Wait for Grafana to start
  ansible.builtin.wait_for:
    port: 3000
    delay: 10
    timeout: 30

- name: Create Grafana data source for Prometheus
  ansible.builtin.uri:
    url: http://localhost:3000/api/datasources
    method: POST
    user: admin  # Default Grafana admin user
    password: admin  # Default Grafana admin password
    body_format: json
    body:
      name: 'Prometheus'
      type: 'prometheus'
      url: 'http://localhost:9090'  # URL for the local Prometheus server
      access: 'proxy'
    status_code: 200  # Expecting HTTP 200 response
    headers:
      Content-Type: application/json

- name: Set Grafana admin password
  ansible.builtin.uri:
    url: http://localhost:3000/api/admin/users/1/password
    method: PUT
    user: admin
    password: admin
    body_format: json
    body:
      password: '{{ grafana_admin_password }}'  # Use a variable for the admin password
    status_code: 200
    headers:
      Content-Type: application/json
