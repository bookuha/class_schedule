#cloud-config
package_update: true
packages:
  - openjdk-11-jdk
  - wget
  - unzip
  - git
  - postgresql-client

runcmd:
  # Install Gradle 7
  - wget https://services.gradle.org/distributions/gradle-7.0-bin.zip -P /tmp
  - unzip -d /opt/gradle /tmp/gradle-7.0-bin.zip
  - ln -s /opt/gradle/gradle-7.0/bin/gradle /usr/bin/gradle

  # Install Tomcat 9
  - wget https://archive.apache.org/dist/tomcat/tomcat-9/v9.0.93/bin/apache-tomcat-9.0.93.tar.gz -P /tmp
  - tar -xzf /tmp/apache-tomcat-9.0.93.tar.gz -C /opt
  - ln -s /opt/apache-tomcat-9.0.93 /opt/tomcat
  - chmod +x /opt/tomcat/bin/catalina.sh
  - mkdir -p /opt/tomcat/webapps

  # Create setenv.sh to pass environment variables to Tomcat
  - |
    cat <<EOF > /opt/tomcat/bin/setenv.sh
    #!/bin/bash
    export DB_HOST=set_postgres_ip_here
    export DB_PORT=5432
    export DB_USER=class_schedule_user
    export DB_PASSWORD=pass
    export DB_NAME=classschedule
    export REDIS_HOST=set_redis_ip_here
    export REDIS_PORT=6379
    export MONGO_CURRENT_DB=schedules
    export MONGO_DEFAULT_SERVER_CLUSTER=set_mongo_ip_here
    EOF
  - chmod +x /opt/tomcat/bin/setenv.sh

  # Clone GitHub repository
  - git clone https://github.com/bookuha/class_schedule.git /usr/app

  # Build the WAR file
  - cd /usr/app && gradle war --stacktrace

  # Deploy WAR file to Tomcat
  - cp /usr/app/build/libs/class_schedule.war /opt/tomcat/webapps/ROOT.war

  # Install restore_backup.sh script
  - cp /usr/app/scripts/restore_backup.sh /usr/local/bin/restore_backup.sh
  - chmod +x /usr/local/bin/restore_backup.sh

  # Start Tomcat
  - /opt/tomcat/bin/catalina.sh run